<!DOCTYPE html>
<html>
  <head>
    <title>Sun Position AR</title>
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <!-- Three.js Location -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js"></script>
    <!-- AR.js -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <!-- SunCalc -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.8.0/suncalc.min.js"></script>
    <!-- Full Tilt -->
    <!-- <script src="js/fulltilt.min.js"></script> -->
		
    <script>
      AFRAME.registerComponent('sun-position', {
        init: function() {
		
	  // Reduces the frequency of Tick
	  this.tick = AFRAME.utils.throttleTick(this.tick, 5000, this);
					
          // Create a new object to store device orientation data
          this.deviceOrientation = {
            alpha: 0
          };
					
          // Create a new a-box element for the sun
          this.sunBox = document.querySelector("#sun");
					
          // Get the current device orientation and update the deviceOrientation object accordingly
          window.addEventListener("deviceorientation", event => {
            this.deviceOrientation.alpha = event.alpha;
          });
        },
	tick: function () {
	    navigator.geolocation.getCurrentPosition(position => {
						
            // Get current latitude and longitude of the user
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            const altitude = position.coords.altitude || 0; // Default to 0 if altitude is not available
            console.log("Latitude: ", latitude ," | Longitude: ", longitude);
						
            // Datetime for the sun position calculation
            //const now = new Date("2023-03-21 11:17:43");
            const now = new Date();
            console.log("Date: ", now);
						
            // Calculate the position of the sun in the sky
            const sunPosition = SunCalc.getPosition(now, latitude, longitude);
	    
            // Set the device alpha value
            console.log("WebkitCompass: " + this.deviceOrientation.webkitCompassHeading);
	    const alpha = this.deviceOrientation.webkitCompassHeading || this.deviceOrientation.alpha;
	    
            // Convert the position of the sun from spherical to cartesian coordinates
            //const r = 149.6e9; // average distance between the sun and the earth
            const r = 50;
		  
            const azimuthDegrees = (180 + (sunPosition.azimuth * 180 / Math.PI)) % 360; // Converting to degrees, changing to azimuth from north rather than south
            const azimuthRadians = azimuthDegrees * Math.PI / 180; // converting back to radians
            const altitudeDegrees = sunPosition.altitude * (180 / Math.PI); // convert to degrees
            const altitudeRadians =  sunPosition.altitude; // just to keep the same naming convention

            console.log("Original Azimuth: ", Math.round(sunPosition.azimuth) ," rads | New Azimuth: ", Math.round(azimuthRadians), " rads");
            console.log("Altitude: ", Math.round(altitudeRadians)," rads");
            console.log("Azimuth: ", Math.round(azimuthDegrees) ,"째 | Altitude: ", Math.round(altitudeDegrees),"째");
            
            // Calculating x,y & z based on Degrees
            const xDeg = Math.round(r * Math.cos(altitudeDegrees) * Math.cos(azimuthDegrees));
            const yDeg = Math.round(r * Math.sin(altitudeDegrees));
            const zDeg = Math.round(-r * Math.cos(altitudeDegrees) * Math.sin(azimuthDegrees));   
            console.log("Position (Degrees)", `${xDeg} ${yDeg} ${zDeg}`);
		    
            // Calculating x,y & z based on Radians
            const xRad = Math.round(r * Math.sin(altitudeRadians) * Math.cos(azimuthRadians));
            const yRad = Math.round(r * Math.cos(altitudeRadians));
            const zRad = Math.round(-r * Math.sin(altitudeRadians) * Math.sin(azimuthRadians));
            console.log("Position (Radians)", `${xRad} ${yRad} ${zRad}`);
		  
            const x = xRad;
            const y = yRad;
            const z = zRad;
		    
            // Update the position of the sun box
            this.sunBox.setAttribute("position", `${x} ${y} ${z}`);
						
            const debugText = document.querySelector(".debugText");
            debugText.innerHTML = "Latitude: " +latitude + " Longitude: "+longitude+"<br>Alpha: " + Math.round(alpha) + " Altitude: " + Math.round(altitudeDegrees) + "째 Azimuth: "+Math.round(azimuthDegrees)+"째 | <br>Position x:" + x + " y:" + y + " z:" + z;
          });
        }
      });
    </script>
  </head>
  <body>
    <div style="position: fixed; bottom: 10px; width:100%; text-align: center; z-index: 1;color:white;background-color:black;">
      <div class="debugText">Test</div>
    </div>
    <a-scene vr-mode-ui="enabled: false" arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false" renderer="antialias: true; alpha: true">
      <a-camera></a-camera>
      <a-box id="sun" sun-position scale="2 2 2" color="yellow"></a-box>
      <a-box scale="1 1 1" color="blue" position="0 1 2"></a-box>
    </a-scene>
  </body>
</html>
