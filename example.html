<!DOCTYPE html>
<html>
  <head>
    <title>Sun Position AR</title>
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <!-- Three.js Location -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js"></script>
    <!-- AR.js -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <!-- SunCalc -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.8.0/suncalc.min.js"></script>
		
    <script>
      AFRAME.registerComponent('sun-position', {
        init: function() {
		
	  // Reduces the frequency of Tick
	  this.tick = AFRAME.utils.throttleTick(this.tick, 5000, this);
					
          // Create a new object to store device orientation data
          this.deviceOrientation = {
            alpha: 0
          };
					
          // Create a new a-box element for the sun
          this.sunBox = document.querySelector("#sun");
					
          // Get the current device orientation and update the deviceOrientation object accordingly
          window.addEventListener("deviceorientation", event => {
            this.deviceOrientation.alpha = event.alpha;
          });
        },
	tick: function () {
	    navigator.geolocation.getCurrentPosition(position => {
						
            // Get current latitude and longitude of the user
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            const altitude = position.coords.altitude || 0; // Default to 0 if altitude is not available
            console.log("Latitude: ", latitude ," | Longitude: ", longitude);
						
            // Datetime for the sun position calculation
            //const now = new Date("2023-03-19 10:00:00");
            const now = new Date();
            console.log("Date: ", now);
						
            // Calculate the position of the sun in the sky
            const sunPosition = SunCalc.getPosition(now, latitude, longitude);
	    
            // Set the device alpha value
	    const alpha = this.deviceOrientation.alpha;
	    
            // Convert the position of the sun from spherical to cartesian coordinates
            //const r = 149.6e9; // average distance between the sun and the earth
            const r = 50;
		  
            const azimuthDegrees = (180 + (sunPosition.azimuth * (180 / Math.PI))) % 360;
            const altitudeDegrees = sunPosition.altitude * (180 / Math.PI);	
            console.log("Azimuth: ", Math.round(azimuthDegrees) ,"째 | Altitude: ", Math.round(altitudeDegrees),"째");
		  
            const x = Math.round(r * Math.sin(azimuthDegrees) * Math.cos(altitudeDegrees));
            const y = Math.round(r * Math.sin(altitudeDegrees));
            const z = Math.round(-r * Math.cos(azimuthDegrees) * Math.cos(altitudeDegrees));
            console.log("Position", `${x} ${y} ${z}`);
		  
            // Update the position of the sun box
            this.sunBox.setAttribute("position", `${x} ${y} ${z}`);
						
            const debugText = document.querySelector(".debugText");
            debugText.innerHTML = "Latitude: " +latitude + " Longitude: "+longitude+"<br>Alpha: " + Math.round(alpha) + " Altitude: " + Math.round(altitudeDegrees) + "째 Azimuth: "+Math.round(azimuthDegrees)+"째 | <br>Position x:" + x + " y:" + y + " z:" + z;
          });
        }
      });
    </script>
  </head>
  <body>
    <div style="position: fixed; bottom: 10px; width:100%; text-align: center; z-index: 1;color:white;background-color:black;">
      <div class="debugText">Test</div>
    </div>
    <a-scene vr-mode-ui="enabled: false" arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false" renderer="antialias: true; alpha: true">
      <a-camera></a-camera>
      <a-box id="sun" sun-position scale="2 2 2" color="yellow"></a-box>
      <a-box scale="1 1 1" color="blue" position="0 1 2"></a-box>
    </a-scene>
  </body>
</html>
