<!DOCTYPE html>
<html>
  <head>
    <title>Sun Position AR</title>
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <!-- Three.js Location -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js"></script>
    <!-- AR.js -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <!-- SunCalc -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.8.0/suncalc.min.js"></script>
		
    <script>
      AFRAME.registerComponent('sun-position', {
        init: function() {
		
	  // Reduces the frequency of Tick
	  this.tick = AFRAME.utils.throttleTick(this.tick, 1000, this);
					
          // Create a new object to store device orientation data
          this.deviceOrientation = {
            alpha: 0
          };
		
          // Set the previous alpha value to null
          this.prevAlpha = null;
					
          // Create a new a-box element for the sun
          this.sunBox = document.querySelector("#sun");
					
          // Get the current device orientation and update the deviceOrientation object accordingly
          window.addEventListener("deviceorientation", event => {
            this.deviceOrientation.alpha = event.alpha;
          });
        },
	tick: function () {
	    navigator.geolocation.getCurrentPosition(position => {
						
            // Get current latitude and longitude of the user
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
		console.log("Latitude: ", latitude ," | Longitude: ", longitude);
            const altitude = position.coords.altitude || 0; // Default to 0 if altitude is not available
						
            const now = new Date("2023-03-19 10:00:00");
						
            // Calculate the position of the sun in the sky
            const sunPosition = SunCalc.getPosition(now, latitude, longitude);
	    console.log('Azimuth:', (sunPosition.azimuth * (180 / Math.PI))+180, 'degrees | Altitude:', sunPosition.altitude * (180 / Math.PI), 'degrees');
						
	    const alpha = this.deviceOrientation.alpha;
	    // Update the alpha value only if it differs by +/- 10 from the previous value in the tick
	    if (this.prevAlpha === null || Math.abs(alpha - this.prevAlpha) >= 10) {
	    	this.prevAlpha = alpha;
	    } else {
	    	alpha = this.prevAlpha;
	    }
	    
            // Convert the position of the sun from spherical to cartesian coordinates
            //const r = 149.6e9; // average distance between the sun and the earth
            const r = 50;
		  
            const azimuthDegrees = alpha + 180 + (sunPosition.azimuth * (180 / Math.PI));
            const altitudeDegrees = sunPosition.altitude * (180 / Math.PI);

            console.log("Azimuth: ", Math.round(azimuthDegrees) ," | Altitude: ", Math.round(altitudeDegrees));
            let adjustedAzimuth = azimuthDegrees + alpha;
            adjustedAzimuth = adjustedAzimuth % 360; // Normalize the adjustedAzimuth value
            if (adjustedAzimuth < 0) {
		adjustedAzimuth += 360; // Handle negative adjustedAzimuth values
            }
		  
            const x = Math.round(r * Math.sin(adjustedAzimuth) * Math.cos(altitudeDegrees));
            const y = Math.round(r * Math.sin(altitudeDegrees));
            const z = Math.round(-r * Math.cos(adjustedAzimuth) * Math.cos(altitudeDegrees));

		  
            // Update the position of the sun box
            this.sunBox.setAttribute("position", `${x} ${y} ${z}`);
            console.log("Position", `${x} ${y} ${z}`);
						
            const debugText = document.querySelector(".debugText");
            debugText.innerHTML = "Al: " + Math.round(alpha) + " Az: "+Math.round(adjustedAzimuth)+" | Position x:" + x + " y:" + y + " z:" + z;
          });
        }
      });
    </script>
  </head>
  <body>
    <div style="position: fixed; bottom: 10px; width:100%; text-align: center; z-index: 1;color:white;background-color:black;">
      <div class="debugText">Test</div>
    </div>
    <a-scene vr-mode-ui="enabled: false" arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false" renderer="antialias: true; alpha: true">
      <a-camera></a-camera>
      <a-box id="sun" sun-position scale="2 2 2" color="yellow"></a-box>
      <a-box scale="1 1 1" color="blue" position="0 1 2"></a-box>
    </a-scene>
  </body>
</html>
